// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Document {
  id             String   @id @default(cuid())
  title          String
  content        String   @db.Text
  status         DocumentStatus @default(DRAFT)
  
  userId         String
  organizationId String
  
  documentType   String   
  jurisdiction   String?  
  category       String?  
  
  aiPrompt       String?  @db.Text
  aiModel        String?  
  generatedAt    DateTime?
  
  // Matter/Case association
  matterId       String?
  matter         Matter?  @relation(fields: [matterId], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  complianceChecks ComplianceCheck[]
  versions         DocumentVersion[]
  signatures       DocumentSignature[]
  shares           DocumentShare[]
  comments         DocumentComment[]
  
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@index([matterId])
}

// Document version history for time-travel feature
model DocumentVersion {
  id             String   @id @default(cuid())
  documentId     String
  document       Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Version info
  version        Int      // Sequential version number
  title          String   // Title at this version
  content        String   @db.Text // Content snapshot
  status         DocumentStatus
  
  // Change metadata
  changeType     VersionChangeType @default(EDIT)
  changeSummary  String?  // Brief description of what changed
  changedFields  String[] // List of fields that changed
  
  // User who made this change
  userId         String
  userName       String?
  userAvatar     String?
  
  // Associated audit log (for linking back to audit trail)
  auditLogId     String?  @unique
  
  createdAt      DateTime @default(now())
  
  @@index([documentId])
  @@index([version])
  @@index([userId])
  @@index([createdAt])
}

enum VersionChangeType {
  CREATE
  EDIT
  STATUS_CHANGE
  AI_REGENERATE
  COMPLIANCE_FIX
  RESTORE
}

model ComplianceCheck {
  id             String   @id @default(cuid())
  documentId     String
  document       Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  status         ComplianceStatus @default(PENDING)
  overallScore   Int?     
  
  issues         Json     
  warnings       Json     
  suggestions    Json     
  
  rulesChecked   Json     // Rules that were applied
  jurisdiction   String?  // Jurisdiction rules used
  documentType   String?  // Document type rules used
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?
  
  @@index([documentId])
  @@index([createdAt])
}

model Notification {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  
  type           NotificationType
  title          String
  message        String   @db.Text
  
  documentId     String?
  complianceId   String?
  
  read           Boolean  @default(false)
  actionUrl      String?
  
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([organizationId])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String?  // Can be null for system events
  organizationId String
  
  action         AuditAction
  actionLabel    String   // Human readable action label
  entityType     String   // Document, User, Compliance, etc.
  entityId       String?  // ID of the affected entity
  entityName     String   // Name/title of the entity
  
  metadata       Json?    // Additional context (oldValue, newValue, etc.)
  
  ipAddress      String?
  userAgent      String?
  location       String?  // Geo-location if available
  device         String?  // Device info extracted from userAgent
  
  userName       String?  // Cached user name for display
  userAvatar     String?  // Cached user initials
  userType       String   @default("user") // "user" or "system"
  
  createdAt      DateTime @default(now())
  
  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

enum DocumentStatus {
  DRAFT
  FINAL
  ARCHIVED
}

enum ComplianceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum NotificationType {
  COMPLIANCE_COMPLETED
  COMPLIANCE_FAILED
  DOCUMENT_SHARED
  DOCUMENT_UPDATED
  SYSTEM_ALERT
}

enum AuditAction {
  DOCUMENT_CREATED
  DOCUMENT_UPDATED
  DOCUMENT_DELETED
  DOCUMENT_VIEWED
  DOCUMENT_EXPORTED
  DOCUMENT_SHARED
  DOCUMENT_SIGNED
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  
  COMPLIANCE_CHECK_RUN
  COMPLIANCE_CHECK_COMPLETED
  AGENTIC_COMPLIANCE_RUN
  AGENTIC_COMPLIANCE_COMPLETED
  
  USER_INVITED
  USER_REMOVED
  USER_ROLE_CHANGED
  USER_LOGIN
  USER_LOGOUT
  
  SYSTEM_BACKUP
  SYSTEM_RESTORE
  SETTINGS_CHANGED
  
  INTEGRATION_CONNECTED
  INTEGRATION_DISCONNECTED
  INTEGRATION_SYNCED
  INTEGRATION_ERROR
}

model Integration {
  id               String   @id @default(cuid())
  organizationId   String
  userId           String   // User who connected the integration
  
  provider         IntegrationProvider
  name             String   // Display name (e.g., "My Google Drive")
  
  status           IntegrationStatus @default(PENDING)
  
  // OAuth tokens (encrypted in production)
  accessToken      String?  @db.Text
  refreshToken     String?  @db.Text
  tokenExpiresAt   DateTime?
  
  // Integration metadata
  externalAccountId String?  // Account ID on the external service
  externalEmail     String?  // Email on the external service
  scope            String[] // OAuth scopes granted
  
  // Sync settings
  syncEnabled      Boolean  @default(true)
  syncFrequency    String   @default("realtime") // realtime, hourly, daily
  lastSyncAt       DateTime?
  lastSyncStatus   String?  // success, error, partial
  lastSyncError    String?  @db.Text
  syncedItemsCount Int      @default(0)
  
  // Feature flags
  settings         Json?    // Integration-specific settings
  features         String[] // Enabled features for this integration
  
  connectedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Sync history
  syncHistory      IntegrationSync[]
  
  @@unique([organizationId, provider])
  @@index([organizationId])
  @@index([provider])
  @@index([status])
}

model IntegrationSync {
  id             String   @id @default(cuid())
  integrationId  String
  integration    Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  status         SyncStatus
  itemsSynced    Int      @default(0)
  itemsFailed    Int      @default(0)
  
  error          String?  @db.Text
  details        Json?    // Detailed sync results
  
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  
  @@index([integrationId])
  @@index([startedAt])
}

enum IntegrationProvider {
  NOTION
  GOOGLE_DRIVE
  DROPBOX
  SLACK
  MICROSOFT_365
  DOCUSIGN
  GOOGLE_SHEETS
  SALESFORCE
  TRELLO
  ASANA
  ZAPIER
  AIRTABLE
  HUBSPOT
}

enum IntegrationStatus {
  PENDING      // OAuth flow started but not completed
  CONNECTED    // Successfully connected and active
  DISCONNECTED // User disconnected
  ERROR        // Connection error (e.g., token expired)
  SUSPENDED    // Temporarily suspended
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  PARTIAL    // Some items failed
  FAILED
}

// ==================== BILLING MODELS ====================

model Subscription {
  id               String   @id @default(cuid())
  organizationId   String   @unique
  
  // Stripe IDs
  stripeCustomerId     String   @unique
  stripeSubscriptionId String?  @unique
  stripePriceId        String?
  
  // Plan details
  plan             PlanType @default(FREE)
  status           SubscriptionStatus @default(TRIALING)
  
  // Limits based on plan
  maxTeamMembers   Int      @default(1)
  maxContracts     Int      @default(1)      // Per month, -1 for unlimited
  maxStorage       Int      @default(0)      // In GB
  
  // Feature flags
  hasAiDrafting        Boolean @default(true)
  hasComplianceAuto    Boolean @default(false)
  hasAnalytics         Boolean @default(false)
  hasCustomTemplates   Boolean @default(false)
  hasPrioritySupport   Boolean @default(false)
  hasCustomIntegrations Boolean @default(false)
  
  // Billing cycle
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean  @default(false)
  canceledAt         DateTime?
  
  // Trial
  trialStart         DateTime?
  trialEnd           DateTime?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relations
  usageRecords       UsageRecord[]
  
  @@index([organizationId])
  @@index([stripeCustomerId])
  @@index([status])
}

model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  type           UsageType
  resourceType   String?
  resourceId     String?
  
  periodStart    DateTime
  periodEnd      DateTime
  
  createdAt      DateTime @default(now())
  
  @@index([subscriptionId])
  @@index([type])
  @@index([periodStart, periodEnd])
}

model WebhookEvent {
  id            String   @id @default(cuid())
  eventId       String   @unique  // Stripe event ID for idempotency
  eventType     String
  processed     Boolean  @default(false)
  attempts      Int      @default(0)
  lastError     String?  @db.Text
  payload       Json
  createdAt     DateTime @default(now())
  processedAt   DateTime?
  
  @@index([eventId])
  @@index([processed])
  @@index([createdAt])
}

enum PlanType {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAUSED
}

enum UsageType {
  DOCUMENT_GENERATED
  COMPLIANCE_CHECK
  STORAGE_USED
  TEAM_MEMBER_ADDED
}

// ==================== TEMPLATE MODELS ====================

model Template {
  id               String   @id @default(cuid())
  
  // Creator info
  userId           String
  organizationId   String?  // Null if personal template
  
  // Template details
  name             String
  description      String   @db.Text
  category         String
  documentType     String
  jurisdiction     String?
  
  // Content
  content          String   @db.Text
  
  // Publishing
  isPublished      Boolean  @default(false)  // Published to Largence directory
  isPublic         Boolean  @default(false)  // Visible to all users
  publishedAt      DateTime?
  
  // Metadata
  version          String   @default("1.0")
  tags             String[]
  
  // Stats
  usageCount       Int      @default(0)
  rating           Float    @default(0)
  reviewCount      Int      @default(0)
  likeCount        Int      @default(0)
  
  // Author info (cached for display)
  authorName       String?
  authorAvatar     String?
  
  // Key features for marketplace display
  keyFeatures      String[]
  includedClauses  String[]
  suitableFor      String[]
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  likes            TemplateLike[]
  ratings          TemplateRating[]
  
  @@index([userId])
  @@index([organizationId])
  @@index([category])
  @@index([isPublished])
  @@index([isPublic])
  @@index([likeCount])
  @@index([rating])
  @@index([usageCount])
}

model TemplateLike {
  id               String   @id @default(cuid())
  
  templateId       String
  template         Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // User identifier - can be anonymous for public users
  sessionId        String?  // For anonymous users
  userId           String?  // For authenticated users
  
  createdAt        DateTime @default(now())
  
  @@unique([templateId, sessionId])
  @@unique([templateId, userId])
  @@index([templateId])
}

model TemplateRating {
  id               String   @id @default(cuid())
  
  templateId       String
  template         Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Rating details
  rating           Int      // 1-5 stars
  review           String?  @db.Text
  
  // User identifier
  sessionId        String?  // For anonymous users
  userId           String?  // For authenticated users
  userName         String?  // Display name
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([templateId, sessionId])
  @@unique([templateId, userId])
  @@index([templateId])
  @@index([rating])
}

// ==================== MATTER/CASE MANAGEMENT ====================

model Matter {
  id               String   @id @default(cuid())
  
  userId           String
  organizationId   String
  
  // Matter details
  name             String
  description      String?  @db.Text
  matterNumber     String?  // Internal reference number
  status           MatterStatus @default(ACTIVE)
  
  // Client information
  clientName       String?
  clientEmail      String?
  clientPhone      String?
  clientCompany    String?
  
  // Matter type and categorization
  matterType       String?  // Litigation, Corporate, Real Estate, etc.
  practiceArea     String?
  
  // Important dates
  openDate         DateTime @default(now())
  closeDate        DateTime?
  dueDate          DateTime?
  
  // Billing
  billingType      BillingType @default(HOURLY)
  hourlyRate       Float?
  flatFee          Float?
  retainerAmount   Float?
  
  // Notes
  notes            String?  @db.Text
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  documents        Document[]
  
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([clientName])
  @@index([matterNumber])
}

enum MatterStatus {
  ACTIVE
  PENDING
  ON_HOLD
  CLOSED
  ARCHIVED
}

enum BillingType {
  HOURLY
  FLAT_FEE
  CONTINGENCY
  RETAINER
  PRO_BONO
}

// ==================== E-SIGNATURES ====================

model DocumentSignature {
  id               String   @id @default(cuid())
  
  documentId       String
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Signer information
  signerName       String
  signerEmail      String
  signerRole       String?  // e.g., "Party A", "Witness", "Notary"
  
  // Signature status
  status           SignatureStatus @default(PENDING)
  
  // Signature data
  signatureData    String?  @db.Text // Base64 encoded signature image
  signatureType    SignatureType @default(DRAW)
  
  // Verification
  ipAddress        String?
  userAgent        String?
  signedAt         DateTime?
  
  // Token for external signers
  accessToken      String   @unique @default(cuid())
  tokenExpiresAt   DateTime
  
  // Order of signing
  signOrder        Int      @default(1)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([documentId])
  @@index([signerEmail])
  @@index([status])
  @@index([accessToken])
}

enum SignatureStatus {
  PENDING
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
}

enum SignatureType {
  DRAW       // Hand-drawn signature
  TYPE       // Typed signature
  UPLOAD     // Uploaded image
}

// ==================== DOCUMENT SHARING ====================

model DocumentShare {
  id               String   @id @default(cuid())
  
  documentId       String
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Share settings
  sharedByUserId   String
  sharedWithEmail  String?  // For external shares
  sharedWithUserId String?  // For internal shares
  
  // Permissions
  permission       SharePermission @default(VIEW)
  
  // Access control
  accessToken      String   @unique @default(cuid())
  password         String?  // Optional password protection
  expiresAt        DateTime?
  
  // Tracking
  viewCount        Int      @default(0)
  lastViewedAt     DateTime?
  
  // Message
  message          String?  @db.Text
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([documentId])
  @@index([sharedWithEmail])
  @@index([accessToken])
}

enum SharePermission {
  VIEW
  COMMENT
  EDIT
  SIGN
}

// ==================== DOCUMENT COMMENTS ====================

model DocumentComment {
  id               String   @id @default(cuid())
  
  documentId       String
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Comment author
  userId           String?  // Null for external commenters
  userName         String
  userEmail        String?
  
  // Comment content
  content          String   @db.Text
  
  // Position in document (for inline comments)
  selectionStart   Int?
  selectionEnd     Int?
  selectedText     String?  @db.Text
  
  // Reply threading
  parentId         String?
  parent           DocumentComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies          DocumentComment[] @relation("CommentReplies")
  
  // Status
  resolved         Boolean  @default(false)
  resolvedAt       DateTime?
  resolvedByUserId String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([documentId])
  @@index([parentId])
  @@index([userId])
}

// ==================== CLAUSE LIBRARY ====================

model Clause {
  id               String   @id @default(cuid())
  
  userId           String
  organizationId   String
  
  // Clause details
  name             String
  description      String?  @db.Text
  content          String   @db.Text
  
  // Categorization
  category         String   // e.g., "Confidentiality", "Indemnification", "Termination"
  subcategory      String?
  tags             String[]
  
  // Metadata
  jurisdiction     String?
  documentTypes    String[] // Document types this clause is suitable for
  
  // Usage tracking
  usageCount       Int      @default(0)
  lastUsedAt       DateTime?
  
  // Favorites
  isFavorite       Boolean  @default(false)
  
  // Version
  version          String   @default("1.0")
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([userId])
  @@index([organizationId])
  @@index([category])
  @@index([usageCount])
}


